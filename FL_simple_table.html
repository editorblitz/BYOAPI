<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forward Look Single Trade Date Table</title>
    <link rel="icon" type="image/png" sizes="96x96" href="https://www.naturalgasintel.com/static/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.naturalgasintel.com/static/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.naturalgasintel.com/static/favicons/favicon-16x16.png">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .utility-buttons {
            margin: 15px 0;
        }
        button {
            padding: 8px 12px;
            margin-right: 10px;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005a87;
        }
        .copy-row-btn {
            padding: 2px 6px;
            font-size: 11px;
            background-color: #28a745;
            margin-left: 5px;
        }
        .copy-row-btn:hover {
            background-color: #1e7e34;
        }
        .copy-col-btn {
            padding: 2px 6px;
            font-size: 10px;
            background-color: #17a2b8;
            margin-top: 2px;
            display: block;
            width: 100%;
        }
        .copy-col-btn:hover {
            background-color: #117a8b;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .month-header {
            background-color: #e8f4f8;
            font-weight: bold;
            text-align: left;
            padding-left: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .metadata {
            background-color: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .table-container {
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .scroll-container {
            border: 1px solid #ddd;
            border-bottom: none;
        }
        .top-scroll {
            height: 17px;
            overflow-x: auto;
            overflow-y: hidden;
        }
        .top-scroll-content {
            height: 1px;
        }
    </style>
</head>
<body>
    <h1>Forward Look Single Trade Date Table</h1>
    
    <div class="form-container">
        <label for="issueDate">Issue Date:</label>
        <input type="date" id="issueDate" name="issueDate">
        
        <div style="margin: 10px 0;">
            <label>
                <input type="radio" id="fixedPrices" name="priceType" value="fixed" checked>
                Fixed Prices
            </label>
            <label style="margin-left: 20px;">
                <input type="radio" id="basisPrices" name="priceType" value="basis">
                Basis Prices
            </label>
        </div>
        
        <button id="loadData">Load Data</button>
    </div>

    <div id="metadataDisplay" class="metadata" style="display: none;">
        <strong>Trade Date:</strong> <span id="tradeDate"></span><br>
        <strong>Issue Date:</strong> <span id="displayIssueDate"></span><br>
        <strong>Price Type:</strong> <span id="priceTypeDisplay"></span><br>
        <strong>Total Locations:</strong> <span id="locationCount"></span><br>
        <strong>Contract Range:</strong> <span id="contractRange"></span>
    </div>

    <div class="utility-buttons" id="utilityButtons" style="display: none;">
        <button id="copyTable">Copy Entire Table to Clipboard</button>
        <button id="showLogs">View Processing Log</button>
    </div>

    <div class="scroll-container" id="scrollContainer" style="display: none;">
        <div class="top-scroll" id="topScroll">
            <div class="top-scroll-content" id="topScrollContent"></div>
        </div>
    </div>
    
    <div class="table-container" id="tableContainer">
        <table id="dataTable" style="display: none;">
            <thead id="tableHeader">
                <!-- Headers will be generated dynamically -->
            </thead>
            <tbody id="tableBody">
                <!-- Data rows will be generated dynamically -->
            </tbody>
        </table>
    </div>

    <div id="loadingMessage" class="loading" style="display: none;">
        Loading forward curve data...
    </div>

    <!-- Modal for logs -->
    <div id="logModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-height: 70vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Data Processing Log</h2>
                <span id="closeModal" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>
            <div id="logContent" style="font-family: monospace; white-space: pre-wrap; background-color: #f5f5f5; padding: 10px; border-radius: 4px;"></div>
        </div>
    </div>

    <script>
        const API_EMAIL = 'chris.newman@naturalgasintel.com';
        const API_KEY = 's96IAubC3mYsYUtLmgL0RqnUQgT5js6S';
        const BASE_URL = 'https://api.ngidata.com/';
        
        // Custom logging system
        const logMessages = [];
        function customLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                console.log(message, data);
                logMessage += '\n' + JSON.stringify(data, null, 2);
            } else {
                console.log(message);
            }
            logMessages.push(logMessage);
        }

        function updateLogModal() {
            const logContent = document.getElementById('logContent');
            logContent.innerHTML = logMessages.map(msg => 
                `<div class="log-entry">${msg}</div>`
            ).join('\n\n');
        }

        // Modal handling
        const modal = document.getElementById('logModal');
        const showLogsBtn = document.getElementById('showLogs');
        const closeBtn = document.getElementById('closeModal');

        showLogsBtn.onclick = function() {
            updateLogModal();
            modal.style.display = 'block';
        }

        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        async function getForwardData(issueDate) {
            const apiUrl = `${BASE_URL}forwardDatafeed.json?issue_date=${issueDate}&email=${encodeURIComponent(API_EMAIL)}&password=${encodeURIComponent(API_KEY)}`;
            const proxyUrl = `https://ngi-proxy.onrender.com/proxy?url=${encodeURIComponent(apiUrl)}`;
            const response = await fetch(proxyUrl);
            const data = await response.json();
            customLog(`Retrieved forward data for ${issueDate}`, data);
            return data;
        }

        function formatDate(dateString) {
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const date = new Date(dateString + 'T00:00:00Z');
            const dayName = days[date.getUTCDay()];
            return `${dateString} (${dayName})`;
        }

        function getContractMonth(contractDate) {
            const [year, month] = contractDate.split('-');
            const monthNames = {
                '01': 'Jan', '02': 'Feb', '03': 'Mar', '04': 'Apr',
                '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Aug',
                '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dec'
            };
            return `${monthNames[month]} ${year}`;
        }

        function copyTableToClipboard() {
            const table = document.getElementById('dataTable');
            const rows = Array.from(table.querySelectorAll('tr')).map(row => 
                Array.from(row.cells).map(cell => {
                    // Skip the copy button cells
                    if (cell.querySelector('.copy-row-btn')) {
                        return '';
                    }
                    // For cells with copy buttons (header cells with location names), extract just the location name
                    if (cell.querySelector('.copy-col-btn')) {
                        // Extract text content before the button
                        const cellHTML = cell.innerHTML;
                        const textBeforeButton = cellHTML.split('<button')[0].trim();
                        return textBeforeButton;
                    }
                    return cell.textContent.trim();
                }).filter(text => text !== '')
            );
            
            const csvContent = rows.map(row => row.join('\t')).join('\n');
            
            navigator.clipboard.writeText(csvContent).then(() => {
                console.log('Table copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy table: ', err);
            });
        }

        function copyRowToClipboard(rowIndex) {
            const table = document.getElementById('dataTable');
            const row = table.rows[rowIndex];
            const rowData = Array.from(row.cells).map(cell => {
                // Skip the copy button cells
                if (cell.querySelector('.copy-row-btn')) {
                    return '';
                }
                return cell.textContent.trim();
            }).filter(text => text !== '');
            
            const rowContent = rowData.join('\t');
            
            navigator.clipboard.writeText(rowContent).then(() => {
                console.log('Row copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy row: ', err);
            });
        }

        function copyColumnToClipboard(columnIndex, locationName) {
            const table = document.getElementById('dataTable');
            const columnData = [];
            
            // Get trade date from metadata and extract just the date (remove day of week)
            const tradeDateFull = document.getElementById('tradeDate').textContent.trim();
            const tradeDate = tradeDateFull.split(' (')[0]; // Extract just the date part before " ("
            
            // Get all data for this column (including the delivery month from column 0)
            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const monthCell = row.cells[0].textContent.trim();
                const priceCell = row.cells[columnIndex].textContent.trim();
                columnData.push(`${monthCell}\t${priceCell}`);
            }
            
            // Combine header and data
            const content = `Delivery Month\t${locationName}\n\t${tradeDate}\n${columnData.join('\n')}`;
            
            navigator.clipboard.writeText(content).then(() => {
                console.log(`Column "${locationName}" copied to clipboard`);
            }).catch(err => {
                console.error('Failed to copy column: ', err);
            });
        }

        async function loadData() {
            const issueDate = document.getElementById('issueDate').value;
            if (!issueDate) {
                alert('Please select an issue date');
                return;
            }

            try {
                // Clear previous logs and show loading
                logMessages.length = 0;
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('dataTable').style.display = 'none';
                document.getElementById('metadataDisplay').style.display = 'none';
                document.getElementById('utilityButtons').style.display = 'none';

                customLog('Starting data retrieval...');
                const data = await getForwardData(issueDate);
                
                if (!data || !data.data) {
                    throw new Error('No data received from API');
                }

                // Get selected price type
                const priceType = document.querySelector('input[name="priceType"]:checked').value;
                const priceKey = priceType === 'fixed' ? 'Fixed Prices' : 'Basis Prices';
                const priceLabel = priceType === 'fixed' ? 'Fixed' : 'Basis';
                
                customLog(`Using ${priceLabel} prices for display`);

                // Update metadata
                document.getElementById('tradeDate').textContent = formatDate(data.meta.trade_date);
                document.getElementById('displayIssueDate').textContent = formatDate(issueDate);
                document.getElementById('priceTypeDisplay').textContent = priceLabel + ' Prices';
                document.getElementById('locationCount').textContent = Object.keys(data.data).length;
                
                // Get all locations sorted alphabetically
                const locations = Object.entries(data.data)
                    .sort(([,a], [,b]) => a.Location.localeCompare(b.Location))
                    .map(([key, locationData]) => ({
                        key: key,
                        name: locationData.Location,
                        contracts: locationData.Contracts,
                        prices: locationData[priceKey]
                    }));

                if (locations.length === 0) {
                    throw new Error('No locations found in data');
                }

                // Get contract range
                const firstLocation = locations[0];
                const contractRange = `${getContractMonth(firstLocation.contracts[0])} - ${getContractMonth(firstLocation.contracts[firstLocation.contracts.length - 1])}`;
                document.getElementById('contractRange').textContent = contractRange;

                // Build table
                const table = document.getElementById('dataTable');
                const thead = document.getElementById('tableHeader');
                const tbody = document.getElementById('tableBody');
                
                // Clear existing content
                thead.innerHTML = '';
                tbody.innerHTML = '';

                // Create header row
                const headerRow = thead.insertRow();
                const monthHeaderCell = headerRow.insertCell(0);
                monthHeaderCell.textContent = 'Delivery Month';
                monthHeaderCell.className = 'month-header';
                
                // Add location columns with copy buttons
                locations.forEach((location, locationIndex) => {
                    const cell = headerRow.insertCell();
                    cell.innerHTML = `
                        ${location.name}
                        <button class="copy-col-btn" onclick="copyColumnToClipboard(${locationIndex + 1}, '${location.name}')">Copy</button>
                    `;
                });
                
                // Add copy button column header
                const copyHeaderCell = headerRow.insertCell();
                copyHeaderCell.textContent = 'Copy Row';
                copyHeaderCell.style.width = '80px';

                // Create data rows (one for each contract month)
                firstLocation.contracts.forEach((contract, contractIndex) => {
                    const row = tbody.insertRow();
                    
                    // Month column
                    const monthCell = row.insertCell(0);
                    monthCell.textContent = getContractMonth(contract);
                    monthCell.className = 'month-header';
                    
                    // Price columns for each location
                    locations.forEach(location => {
                        const cell = row.insertCell();
                        const price = parseFloat(location.prices[contractIndex]);
                        cell.textContent = price.toFixed(3);
                    });
                    
                    // Copy row button
                    const copyCell = row.insertCell();
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Copy';
                    copyBtn.className = 'copy-row-btn';
                    copyBtn.onclick = () => copyRowToClipboard(row.rowIndex);
                    copyCell.appendChild(copyBtn);
                });

                customLog(`Table built with ${locations.length} locations and ${firstLocation.contracts.length} contract months`);

                // Show the table and controls
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('metadataDisplay').style.display = 'block';
                document.getElementById('utilityButtons').style.display = 'block';
                document.getElementById('scrollContainer').style.display = 'block';
                
                // Set up synchronized scrolling
                setupSynchronizedScrolling();

            } catch (error) {
                customLog('Error loading data: ' + error.message);
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                alert('Error loading data: ' + error.message);
            }
        }

        function setupSynchronizedScrolling() {
            const topScroll = document.getElementById('topScroll');
            const tableContainer = document.getElementById('tableContainer');
            const topScrollContent = document.getElementById('topScrollContent');
            const table = document.getElementById('dataTable');
            
            // Set the width of the top scroll content to match the table width
            topScrollContent.style.width = table.scrollWidth + 'px';
            
            // Synchronize scrolling from top scroll to table
            topScroll.addEventListener('scroll', function() {
                tableContainer.scrollLeft = topScroll.scrollLeft;
            });
            
            // Synchronize scrolling from table to top scroll
            tableContainer.addEventListener('scroll', function() {
                topScroll.scrollLeft = tableContainer.scrollLeft;
            });
        }

        // Event listeners
        document.getElementById('copyTable').addEventListener('click', copyTableToClipboard);
        document.getElementById('loadData').addEventListener('click', loadData);

        // Set default date to today
        document.getElementById('issueDate').valueAsDate = new Date();
    </script>
</body>
</html>